# Apache HTTPS (port 443) configuration for deplake.tk
# Location: /etc/apache2/sites-available/deplake-tk-le-ssl.conf
#
# This configuration handles all HTTPS traffic.
# SSL certificates are managed by Let's Encrypt (certbot).

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerAdmin webmaster@localhost
    ServerName deplake.tk
#   ServerAlias www.deplake.tk
    DocumentRoot /var/www/deplake-tk
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # SSL Configuration (Let's Encrypt certificates)
    SSLCertificateFile /etc/letsencrypt/live/deplake.tk/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/deplake.tk/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Custom 503 error page (served from Apache, not proxied)
    ErrorDocument 503 /503.html
    ProxyPass /503.html !

    ProxyPreserveHost On
    ProxyRequests Off

    # Backend API routes - proxy to Java backend Docker container on port 8080
    # IMPORTANT: Do NOT add "ProxyPass / http://127.0.0.1:8080/" here!
    # That would proxy everything to backend instead of serving frontend files.

    ProxyPass /api http://127.0.0.1:8080/api Keepalive=On
    ProxyPassReverse /api http://127.0.0.1:8080/api

    ProxyPass /token http://127.0.0.1:8080/token Keepalive=On
    ProxyPassReverse /token http://127.0.0.1:8080/token

    ProxyPass /logs http://127.0.0.1:8080/logs Keepalive=On
    ProxyPassReverse /logs http://127.0.0.1:8080/logs

    ProxyPass /mobile-app http://127.0.0.1:8080/mobile-app Keepalive=On
    ProxyPassReverse /mobile-app http://127.0.0.1:8080/mobile-app

    # Frontend served directly from Apache filesystem
    # Apache will serve files from DocumentRoot (/var/www/deplake-tk)
    # for all requests that don't match the ProxyPass rules above
    <Directory /var/www/deplake-tk>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Angular routing - handle client-side routes
        # This ensures that Angular routes like /dashboard, /reports work correctly
        RewriteEngine On
        RewriteBase /
        # If requesting index.html directly, serve it
        RewriteRule ^index\.html$ - [L]
        # If file or directory exists, serve it
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        # If NOT an API route, serve index.html for Angular routing
        RewriteCond %{REQUEST_URI} !^/(api|token|logs|mobile-app)
        RewriteRule . /index.html [L]
    </Directory>
</VirtualHost>
</IfModule>
